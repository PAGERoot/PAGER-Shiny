---
title: "Gene expression analysis"
author: "Guillaume Lobet"
date: "12 January 2016"
output: html_document
---

```{r, echo=F}
# Load libraries
library(ggplot2)
library(plyr)
library(XML)
library(RColorBrewer)
library(reshape2)
```

This project aims at developing an analysis pipeline for gene expression data coming from CellSet. In the end the idea will be to have a Shiny app with the analysis


Lets first create some dummy data. 

```{r}
tissues <- c("endodermis", "lateral_root_cap", "stele", "quiescent_center", "epidermis", "cortex", "pericycle", "cortex_initials", "columella_root_cap")
rs <- data.frame(tissue=factor(), value=numeric(), plant=factor())
reps <- 20
nrows <- reps * length(tissues)
gens <- c("col0", "myc-wr9", "atataat-wr3", "telo-wr7", "l12-899")
for(n in gens){
temp <- data.frame(tissue = rep(tissues, reps), 
                 value = rnorm(nrows, mean = runif(1, 0, 10)), 
                 plant = rep(n, nrows))
rs <- rbind(rs, temp)
}
rs$plant <-factor(rs$plant)
write.csv(rs, "~/Desktop/cellset.csv")
remove(temp, i, reps, nrows)

p.list <- unique(rs$plant)
```

Let look then at the distribution of the data. Since this is coming from GFP datasets, some background difference could appear between the different images. Histogram normalisation should be able to get rid of this.

```{r, echo=FALSE}
ggplot(rs, aes(x=value, fill=plant, colour=plant)) +
  geom_density(alpha=0.4, lwd=0.8, adjust=0.5) +
  theme_bw()
```

We can see that we need to normalise the overall datasets. the first one will serve as the target for the next ones. 

```{r}

for(n in p.list[2:length(p.list)]){
  rs$value[rs$plant == n] <- rs$value[rs$plant == n] - 
            (mean(rs$value[rs$plant == n]) - 
              mean(rs$value[rs$plant == p.list[1]]))
}

ggplot(rs, aes(x=value, fill=plant, colour=plant)) +
  geom_density(alpha=0.4, lwd=0.8, adjust=0.5) +
  theme_bw()

```

This seems to be working fine for now. We'll have to see how it works with real data in the future. 

Now we have to merge the data by tissue to compare them to each other

```{r}
library(plyr)
rs.agg <- ddply(rs, .(plant, tissue), summarize, value=mean(value))

# Check for the number of lines
nrow(rs.agg) == length(tissues) * length(p.list)

```


Now comes the trickey part. We need to compare the expression of the different tissues in the different plants. 

First we can try to make a regression between the mutants and the wild type, on an organ basis. 

```{r}
# Create a new variable containing the wild type data

rs.agg$wt <- rep(rs.agg$value[rs.agg$plant == p.list[1]], length(p.list))

ggplot(rs.agg, aes(wt, value, colour=plant)) + 
  geom_point(size=3) + 
  geom_smooth(method=lm, se=F) + 
  theme_bw()

```

This is not very convincing and does not seem to be very usefull for what we want to do. Maybe we can try to use the differences between each plant and the wild type.

```{r}

rs.agg$diff <- rs.agg$value - rs.agg$wt
rs.agg$x <- as.numeric(rs.agg$tissue)

ggplot(rs.agg, aes(x, diff, colour=plant)) + 
  geom_line(size=1) + 
  geom_point(size=3) +
  scale_x_discrete(breaks= c(1:length(tissues)),labels=tissues) + 
  theme_bw()

```

Now we can add the mean difference across th data on the plot. This could serve as a threshold to dtect the significan differences. 

```{r}

mean.diff <- mean(abs(rs.agg$diff))

rs.agg$type <- 0
rs.agg$type[rs.agg$diff < -mean.diff | rs.agg$diff > mean.diff] <- 1

ggplot(rs.agg, aes(x, diff, colour=plant)) + 
  geom_rect(aes(xmin=min(rs.agg$x), xmax=max(rs.agg$x), 
                ymin=-mean.diff, ymax=mean.diff), 
                fill="lightgrey", color="lightgrey", alpha=0.5) +
  geom_line(size=1) + 
  geom_line(data = rs.agg[rs.agg$plant == 2,], aes(x, diff), colour="#FF7C00", size=1) + 
  geom_point(data=rs.agg[rs.agg$type == 1 & rs.agg$plant == 2,], aes(x, diff), colour="#FF7C00",size=6, pch=1) +
  geom_point(size=3) +
  geom_point(data=rs.agg[rs.agg$plant == 2,], aes(x, diff), colour="#FF7C00", size=3) +
  scale_x_discrete(breaks= c(1:length(tissues)),labels=tissues) +
  scale_colour_grey()+
  theme_bw()

```


Maybe it is worth looking at the difference by tissue? Need to check if this has a significance biologically. 


```{r}

mean.diff <- ddply(rs.agg, .(tissue), summarize, val=mean(abs(diff)))

rs.agg$type <- 0
for(n in tissues){
  rs.agg$type[rs.agg$tissue == n &
                rs.agg$diff < -mean.diff$val[mean.diff$tissue == n]] <- 1
    rs.agg$type[rs.agg$tissue == n &
                rs.agg$diff > mean.diff$val[mean.diff$tissue == n]] <- 1
}

ggplot(rs.agg, aes(x, diff, colour=plant)) + 
  geom_line(size=1) + 
  geom_point(data=rs.agg[rs.agg$type == 1,], 
             aes(x, diff, colour=plant), size=5, pch=1) +
  geom_point(size=3) +
  scale_x_discrete(breaks= c(1:length(tissues)),labels=tissues) +
  theme_bw()

```


try to map the data on an SVG graphic (because it looks better that way!).The problem is that there is not solution for SVG display... Only a depracted one. May by trying to load SVG as an XML and modify it? 

Thanks here to Pierre Tocquin for the tips on the XML handling.

```{r}

# Open the SVG as an XML file
root <- xmlParse("~/Desktop/root.svg")

# Create a color palette for the gene expression
temp <- rs.agg[rs.agg$plant == 1,]
co <- round(temp$value*10)
if(min(co) < 0) co <- co + abs(min(co))
if(min(co) > 0) co <- co - abs(min(co))
temp$col <- co + 1
my.col <- colorRampPalette(c("yellow", "red"))(diff(range(co))+1)


# Modifyt the SVG for each tissue
for(n in tissues){
  node = xpathApply(root, paste0("//*[@id='",n,"']/*"))
  sapply(node, function(x) {
    oldstyle <- xmlAttrs(x)
    removeAttributes(x, "style")
    xmlAttrs(x)<-c(gsub("fill:#fff", paste0("fill:",my.col[temp$col[temp$tissue == n]]),
                        oldstyle['style']))    
  })
}
# Save the new file
saveXML(root, file='~/Desktop/current_root.svg')


# Use the command line to convert the svg to png for further use. 
setwd("~/Desktop")
system("qlmanage -t -s 500 -o . current_root.svg")

```

So everything seems to be working so. Time to move to the shiny app for the demo. 

### Dummy data test
  2016-01-25
  
So, JosÃ© sent me some dummy data that I can try out. 



```{r}
library(MASS)
report <- read.table("www/ReporterExpression.txt", header = T)
genes <- read.table("www/GeneExpression.txt", header = T)

report$Cell_type <- as.character(report$Cell_type)
for(i in 1:nrow(report)) report$Cell_type[i] <- strsplit(report$Cell_type[i], "_")[[1]][1]
report$Cell_type <- factor(report$Cell_type)

report[,2:ncol(report)] <-scale(report[,2:ncol(report)])
report_1 <- melt(report, id.vars = ("Cell_type"))
ggplot(report_1, aes(x=value, fill=Cell_type, colour=Cell_type)) +
  geom_density(alpha=0.4, lwd=0.8, adjust=0.5) +
  theme_bw()



fit <- lda(Cell_type ~ ., data=report)
prop = fit$svd^2/sum(fit$svd^2)

fit.p <- predict(fit, newdata = report[,c(2:ncol(report))])
ct <- table(fit.p$class, report[,1])
diag(prop.table(ct, 1))
print(sum(diag(prop.table(ct))))


fit.p <- predict(fit, newdata = genes[,c(2:ncol(genes))])

fit.p$posterior
```
